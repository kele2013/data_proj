upsert INTO dim_core_space  SELECT concat(concat(cast(t.id AS string),
        cast(t.project_id AS string)),
        cast(t.tenant_id AS string)) the_key,
         t.id,
         t.tenant_id,
         t.project_id,
         t.building_id,
         t.type,
         t.source_id,
         t.code,
         -1 AS level1_format_id,
         '' AS level1_format_name, -1 AS level2_format_id, '' AS level2_format_name, t.building_type, t.building_name, t.floor_no, '' AS room_no, '' AS plan_room_no, t.name, t.full_name, t.build_area, t.inside_area, 0 AS remaining_build_area, 0 AS remaining_inside_area, '' manage_attribute, '' location_flink, '' location_type, t.is_enabled, t.description, '' AS resident_status, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.create_time AS string))+28800) AS timestamp(3)) create_time, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.update_time AS string))+28800) AS timestamp(3)) update_time, 0 AS delete_flag
FROM spc_space t
WHERE t.delete_flag=0
        AND t.type NOT IN ('MANAGEHOUSE' , 'PLANHOUSE', 'PUBLICAREA')
UNION
SELECT concat(concat(concat(cast(t.id AS string),
        cast(t.project_id AS string)),
        cast(t.tenant_id AS string)),
        cast(ifnull(t1.room_no,
        'null') AS string)) the_key, t.id, t.tenant_id, t.project_id, t.building_id, t.type, t.source_id, t.code, t1.level1_format_id, t2.name AS level1_format_name, t1.level2_format_id , t3.name AS level2_format_name, t.building_type, t.building_name, t.floor_no, t1.room_no , t1.room_no AS plan_room_no, t.name, t.full_name, t.build_area, t.inside_area, t1.remaining_build_area, t1.remaining_inside_area, '' manage_attribute, '' location_flink, '' location_type, t.is_enabled, t.description, t1.resident_status, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.create_time AS string))+28800) AS timestamp(3)) create_time, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.update_time AS string))+28800) AS timestamp(3)) update_time, t.delete_flag
FROM spc_space t
LEFT JOIN spc_plan_house t1
    ON t.source_id=t1.id
LEFT JOIN spc_format t2
    ON t1.level1_format_id=t2.id
        AND t2.delete_flag=0
LEFT JOIN spc_format t3
    ON t1.level2_format_id=t3.id
        AND t3.delete_flag=0
WHERE t.type='PLANHOUSE'
UNION
SELECT concat(concat(concat(cast(t.id AS string),
        cast(t.project_id AS string)),
        cast(t.tenant_id AS string)),
        ifnull(t.name,
        'null')) the_key, t.id, t.tenant_id, t.project_id, t.building_id, t.type, t.source_id, t.code, -1 AS level1_format_id, '公区' AS level1_format_name, -1 AS level2_format_id, '公区' AS level2_format_name, t.building_type, t.building_name, t.floor_no, t.name AS room_no, '' AS plan_room_no, t.name, t.full_name, t.build_area, t.inside_area, t1.area AS remaining_build_area, t1.area AS remaining_inside_area, t1.manage_attribute, t1.location_flink AS location_flink, t1.location_type, t.is_enabled, t.description, '' AS resident_status, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.create_time AS string))+28800) AS timestamp(3)) create_time, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.update_time AS string))+28800) AS timestamp(3)) update_time, t.delete_flag
FROM spc_space t
LEFT JOIN spc_public_area3 t1
    ON t.source_id=t1.id
WHERE t.type='PUBLICAREA'
UNION
SELECT concat(concat(concat(cast(t.id AS string),
        cast(t.project_id AS string)),
        cast(t.tenant_id AS string)),
        cast(ifnull(t1.no_flink,
        'null') AS string)) the_key, t.id, t.tenant_id, t.project_id, t.building_id, t.type, t.source_id, t.code, t9.level1_format_id, t2.name AS level1_format_name, t9.level2_format_id , t3.name AS level2_format_name, t.building_type, t.building_name, t.floor_no, t1.no_flink AS room_no , t9.room_no AS plan_room_no, t.name, t.full_name, t.build_area, t.inside_area, t9.remaining_build_area, t9.remaining_inside_area, '' manage_attribute, '' location_flink, '' location_type, t.is_enabled, t.description, t1.resident_status, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.create_time AS string))+28800) AS timestamp(3)) create_time, cast(FROM_UNIXTIME(UNIX_TIMESTAMP(cast(t.update_time AS string))+28800) AS timestamp(3)) update_time, 0 AS delete_flag
FROM spc_space t
LEFT JOIN spc_manage_house t1
    ON t.source_id=t1.id
        AND t1.delete_flag=0
LEFT JOIN 
    (SELECT t8.manage_house_id ,
        sum(t4.remaining_build_area) remaining_build_area ,
        sum(t4.remaining_inside_area) remaining_inside_area ,
        LISTAGG(t4.room_no) room_no ,
        max(t4.level1_format_id) level1_format_id ,
        max(t4.level2_format_id) level2_format_id
    FROM spc_manage_house_source_map t8
    LEFT JOIN spc_plan_house t4
        ON t8.source_space_id=t4.id
    WHERE t8.delete_flag=0
            AND t4.delete_flag=0
    GROUP BY  t8.manage_house_id ) t9
    ON t1.id=t9.manage_house_id
LEFT JOIN spc_format t2
    ON t9.level1_format_id=t2.id
        AND t2.delete_flag=0
LEFT JOIN spc_format t3
    ON t9.level2_format_id=t3.id
        AND t3.delete_flag=0
WHERE t.delete_flag=0
        AND t.type='MANAGEHOUSE'